import{j as e}from"./ui-vendor-_s0klCrL.js";import{u as ke,b as t}from"./react-vendor-C7VPsBAG.js";import{c as ve,u as Ce,_ as Ne,C as N,h as b,a1 as Y,i as y,j as S,k as L,B as i,A as be,s as U,v as D,w as F,x as E,y as n,am as ye,ay as Se,a9 as we,F as x,r as w,D as P,I as _,aj as G}from"./index-BLJ_ytcB.js";import{D as J,a as K,b as Q,c as W,d as X,e as Z}from"./dialog-BPAt-TF-.js";import{S as Ae}from"./square-Bkony4Hd.js";import{S as Te}from"./square-check-big-CO7qm0JX.js";import{D as B}from"./dollar-sign-xVsTkna1.js";import"./utils-vendor-DYGWDIxX.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const I=ve("LockOpen",[["rect",{width:"18",height:"11",x:"3",y:"11",rx:"2",ry:"2",key:"1w4ew1"}],["path",{d:"M7 11V7a5 5 0 0 1 9.9-1",key:"1mm8w8"}]]);function Re(){const[,R]=ke(),{isAdmin:ee,isAuthenticated:se,isLoading:ae}=Ce(),{toast:r}=Ne(),[p,te]=t.useState(""),[q,re]=t.useState([]),[d,ce]=t.useState([]),[h,le]=t.useState(null),[ie,j]=t.useState(!1),[o,g]=t.useState("free"),[V,f]=t.useState("0"),[l,k]=t.useState([]),[ne,v]=t.useState(!1),[m,$]=t.useState("free"),[O,M]=t.useState("0"),[C,H]=t.useState(!1),z=t.useCallback(async()=>{H(!0);try{const s=await fetch("/api/series",{credentials:"include"});if(s.ok){const a=await s.json();re(a)}}catch{}finally{H(!1)}},[]);t.useEffect(()=>{z()},[z]);const A=async()=>{if(!p.trim()){r({title:"Error",description:"Please select a series",variant:"error"});return}try{const s=await fetch(`/api/series/${p}/chapters`,{credentials:"include"});if(!s.ok)throw new Error("Series not found");const a=await s.json();ce(a),r({title:"Series Loaded",description:`Found ${a.length} chapters`})}catch(s){r({title:"Error",description:s.message||"Failed to load series",variant:"error"})}},de=async s=>{le(s);try{const a=await fetch(`/api/chapters/${s.id}/access`,{credentials:"include"});if(a.ok){const c=await a.json();g(c.accessType||"free"),f((c.unlockCost||0).toString())}else g("free"),f("0")}catch{g("free"),f("0")}j(!0)},oe=async()=>{if(!h)return;const s=o==="free"?0:parseInt(V);if(o!=="free"&&(!s||s<0)){r({title:"Error",description:"Please enter a valid unlock cost for non-free chapters",variant:"error"});return}try{await G("POST",`/api/admin/chapters/${h.id}/access`,{accessType:o,unlockCost:s}),A(),j(!1),r({title:"Access Updated",description:`Chapter access set to ${o}`})}catch(a){r({title:"Error",description:a.message||"Failed to update access",variant:"error"})}},he=s=>{k(a=>a.includes(s)?a.filter(c=>c!==s):[...a,s])},me=()=>{l.length===d.length?k([]):k(d.map(s=>s.id))},ue=async()=>{if(l.length===0){r({title:"Error",description:"Please select at least one chapter",variant:"error"});return}const s=m==="free"?0:parseInt(O);if(m!=="free"&&(!s||s<0)){r({title:"Error",description:"Please enter a valid unlock cost for non-free chapters",variant:"error"});return}try{const a=await G("POST","/api/admin/chapters/bulk-access",{chapterIds:l,accessType:m,unlockCost:s});if(A(),v(!1),k([]),$("free"),M("0"),a.failureCount>0){const c=a.results.filter(u=>!u.success),T=c.slice(0,3),pe=c.length>3;r({title:"Partial Success",description:e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{children:a.message}),e.jsxs("div",{className:"text-xs mt-2 space-y-1",children:[e.jsx("p",{className:"font-semibold",children:"Failed chapters:"}),T.map((u,je)=>{const ge=d.find(fe=>fe.id===u.chapterId);return e.jsxs("p",{children:["â€¢ Chapter ",ge?.chapterNumber||u.chapterId,": ",u.error]},je)}),pe&&e.jsxs("p",{className:"text-muted-foreground",children:["...and ",c.length-3," more"]})]})]}),variant:"default"})}else r({title:"Bulk Update Complete",description:a.message})}catch(a){const c=a.message||"Failed to update chapters",T=c.includes("Invalid input");r({title:T?"Validation Error":"Update Failed",description:c,variant:"error"})}},xe=s=>{switch(s){case"free":return e.jsxs(x,{variant:"secondary",children:[e.jsx(I,{className:"w-3 h-3 mr-1"})," Free"]});case"premium":return e.jsxs(x,{className:"bg-primary",children:[e.jsx(B,{className:"w-3 h-3 mr-1"})," Premium"]});case"locked":return e.jsxs(x,{variant:"destructive",children:[e.jsx(P,{className:"w-3 h-3 mr-1"})," Locked"]});default:return e.jsx(x,{variant:"outline",children:"Unknown"})}};return ae?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-background via-background to-background/95 flex items-center justify-center p-4",children:e.jsx(N,{className:"max-w-md w-full bg-card/80 backdrop-blur-md border-border/50",children:e.jsxs(b,{className:"text-center",children:[e.jsx("div",{className:"mx-auto mb-4 w-16 h-16 rounded-full bg-primary/10 flex items-center justify-center",children:e.jsx(Y,{className:"w-8 h-8 text-primary animate-pulse"})}),e.jsx(y,{className:"text-2xl",children:"Loading..."}),e.jsx(S,{className:"mt-2",children:"Verifying your permissions"})]})})}):!se||!ee?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-background via-background to-background/95 flex items-center justify-center p-4",children:e.jsxs(N,{className:"max-w-md w-full bg-card/80 backdrop-blur-md border-border/50",children:[e.jsxs(b,{className:"text-center",children:[e.jsx("div",{className:"mx-auto mb-4 w-16 h-16 rounded-full bg-primary/10 flex items-center justify-center",children:e.jsx(Y,{className:"w-8 h-8 text-primary"})}),e.jsx(y,{className:"text-2xl",children:"Admin Access Required"}),e.jsx(S,{className:"mt-2",children:"You need admin privileges to access chapter access management"})]}),e.jsx(L,{children:e.jsx(i,{onClick:()=>R("/"),className:"w-full",children:"Return to Home"})})]})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs(i,{variant:"ghost",onClick:()=>R("/admin"),className:"w-fit text-muted-foreground hover:text-primary mb-4",children:[e.jsx(be,{className:"w-4 h-4 mr-2"}),"Back"]}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-3xl font-bold tracking-tight",children:"Chapter Access Control"}),e.jsx("p",{className:"text-muted-foreground",children:"Manage chapter pricing and access types (free, premium, locked)"})]}),e.jsxs(N,{children:[e.jsxs(b,{children:[e.jsx(y,{children:"Select Series"}),e.jsx(S,{children:"Choose a series to manage chapter access and pricing"})]}),e.jsx(L,{children:e.jsxs("div",{className:"flex gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsxs(U,{value:p,onValueChange:te,disabled:C,children:[e.jsx(D,{children:e.jsx(F,{placeholder:C?"Loading series...":"Select a series..."})}),e.jsxs(E,{children:[q.length===0&&!C&&e.jsx(n,{value:"none",disabled:!0,children:"No series available"}),q.map(s=>e.jsx(n,{value:s.id,children:s.title},s.id))]})]})}),e.jsxs(i,{onClick:A,disabled:!p||C,children:[e.jsx(ye,{className:"w-4 h-4 mr-2"}),"Load Chapters"]})]})})]}),d.length>0&&e.jsxs(N,{children:[e.jsx(b,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs(y,{children:["Chapters (",d.length,")"]}),e.jsx(S,{children:"Select chapters for bulk actions or click to edit individually"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(i,{variant:"outline",size:"sm",onClick:me,children:l.length===d.length?e.jsxs(e.Fragment,{children:[e.jsx(Ae,{className:"w-4 h-4 mr-2"}),"Deselect All"]}):e.jsxs(e.Fragment,{children:[e.jsx(Te,{className:"w-4 h-4 mr-2"}),"Select All"]})}),l.length>0&&e.jsxs(i,{onClick:()=>v(!0),children:["Bulk Update (",l.length,")"]})]})]})}),e.jsx(L,{children:e.jsx("div",{className:"space-y-2",children:d.map(s=>e.jsxs("div",{className:"flex items-center gap-3 p-4 border border-border rounded-lg hover:bg-accent/50 transition-colors",children:[e.jsx(Se,{checked:l.includes(s.id),onCheckedChange:()=>he(s.id),onClick:a=>a.stopPropagation()}),e.jsxs("div",{className:"flex-1 flex items-center justify-between cursor-pointer",onClick:()=>de(s),children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"font-medium",children:["Chapter ",s.chapterNumber,": ",s.title||"Untitled"]}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[s.pages?.length||0," pages"]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[s.accessType&&xe(s.accessType),s.unlockCost>0&&e.jsxs("div",{className:"flex items-center gap-1 text-sm text-muted-foreground",children:[e.jsx(we,{className:"w-4 h-4"}),s.unlockCost]}),e.jsx(x,{variant:s.isPublished==="true"?"default":"secondary",children:s.isPublished==="true"?"Published":"Draft"})]})]})]},s.id))})})]}),e.jsx(J,{open:ie,onOpenChange:j,children:e.jsxs(K,{children:[e.jsxs(Q,{children:[e.jsx(W,{children:"Set Chapter Access"}),e.jsx(X,{children:h&&`Chapter ${h.chapterNumber}: ${h.title||"Untitled"}`})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(w,{htmlFor:"accessType",children:"Access Type"}),e.jsxs(U,{value:o,onValueChange:g,children:[e.jsx(D,{id:"accessType",children:e.jsx(F,{})}),e.jsxs(E,{children:[e.jsx(n,{value:"free",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(I,{className:"w-4 h-4"}),"Free - Available to all users"]})}),e.jsx(n,{value:"premium",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(B,{className:"w-4 h-4"}),"Premium - Requires coins to unlock"]})}),e.jsx(n,{value:"locked",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(P,{className:"w-4 h-4"}),"Locked - Restricted access"]})})]})]})]}),o!=="free"&&e.jsxs("div",{children:[e.jsx(w,{htmlFor:"unlockCost",children:"Unlock Cost (Coins)"}),e.jsx(_,{id:"unlockCost",type:"number",placeholder:"Enter cost in coins",value:V,onChange:s=>f(s.target.value),min:"0"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Users will need to spend this many coins to unlock this chapter"})]}),e.jsxs("div",{className:"bg-muted/50 p-4 rounded-lg",children:[e.jsx("h4",{className:"font-semibold mb-2",children:"Access Types Explained:"}),e.jsxs("ul",{className:"text-sm space-y-1 text-muted-foreground",children:[e.jsxs("li",{children:[e.jsx("strong",{children:"Free:"})," Available to all users"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Premium:"})," Requires coins, one-time unlock"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Locked:"})," Restricted, requires special access"]})]})]})]}),e.jsxs(Z,{children:[e.jsx(i,{variant:"outline",onClick:()=>j(!1),children:"Cancel"}),e.jsx(i,{onClick:oe,children:"Update Access"})]})]})}),e.jsx(J,{open:ne,onOpenChange:v,children:e.jsxs(K,{children:[e.jsxs(Q,{children:[e.jsx(W,{children:"Bulk Update Access"}),e.jsxs(X,{children:["Update access type for ",l.length," selected chapters"]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(w,{htmlFor:"bulkAccessType",children:"Access Type"}),e.jsxs(U,{value:m,onValueChange:$,children:[e.jsx(D,{id:"bulkAccessType",children:e.jsx(F,{})}),e.jsxs(E,{children:[e.jsx(n,{value:"free",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(I,{className:"w-4 h-4"}),"Free - Available to all users"]})}),e.jsx(n,{value:"premium",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(B,{className:"w-4 h-4"}),"Premium - Requires coins to unlock"]})}),e.jsx(n,{value:"locked",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(P,{className:"w-4 h-4"}),"Locked - Restricted access"]})})]})]})]}),m!=="free"&&e.jsxs("div",{children:[e.jsx(w,{htmlFor:"bulkUnlockCost",children:"Unlock Cost (Coins)"}),e.jsx(_,{id:"bulkUnlockCost",type:"number",placeholder:"Enter cost in coins",value:O,onChange:s=>M(s.target.value),min:"0"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"All selected chapters will use this unlock cost"})]}),e.jsxs("div",{className:"bg-muted/50 p-4 rounded-lg",children:[e.jsxs("p",{className:"text-sm font-medium",children:["Selected Chapters: ",l.length]}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"This will update the access type and unlock cost for all selected chapters"})]})]}),e.jsxs(Z,{children:[e.jsx(i,{variant:"outline",onClick:()=>v(!1),children:"Cancel"}),e.jsx(i,{onClick:ue,children:"Update All"})]})]})})]})}export{Re as default};
